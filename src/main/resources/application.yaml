# =============================================================================
# LLM Gateway - 基礎共用配置
# =============================================================================
# 此檔案包進 Docker Image，包含所有環境共用的配置
# 環境特定配置透過 config/ 目錄下的 profile 檔案覆蓋
#
# 環境變數命名規則:
#   - 應用程式專屬: 使用 Spring 屬性名稱 (如 spring.profiles.default)
#   - 業界標準: 保持原樣 (如 OTEL_EXPORTER_OTLP_ENDPOINT)
# =============================================================================

spring:
  application:
    name: gate
  security:
    oauth2:
      resourceserver:
        jwt:
          # 預設值供 AOT 編譯使用，執行時由各環境提供 gate-jwt-jwk-set-uri 屬性覆蓋
          jwk-set-uri: ${gate-jwt-jwk-set-uri:https://placeholder.example.com/.well-known/jwks.json}
  profiles:
    # 預設 profiles（可被 spring.profiles.active 覆蓋）
    # 本地開發: 自動使用 local,dev
    default: local,dev
  cloud:
    # 禁用 RefreshScope - Spring Cloud RefreshScope 不支援 AOT/Native Image
    # 參考: https://github.com/spring-cloud/spring-cloud-release/wiki/AOT-transformations-and-native-image-support
    refresh:
      enabled: false
    gateway:
      server:
        webmvc:
          enabled: true
    # Spring Cloud Stream 配置
    # Topic 名稱固定為 llm-gateway-usage
    stream:
      bindings:
        usageEvent-out-0:
          destination: llm-gateway-usage
          content-type: application/cloudevents+json

# Anthropic API 配置
anthropic:
  api:
    base-url: https://api.anthropic.com
    keys: []

# Resilience4j 配置
resilience4j:
  circuitbreaker:
    instances:
      anthropic-api:
        failure-rate-threshold: 50
        slow-call-rate-threshold: 100
        slow-call-duration-threshold: 30s
        wait-duration-in-open-state: 60s
        permitted-number-of-calls-in-half-open-state: 10
        sliding-window-size: 100
        sliding-window-type: COUNT_BASED

# Actuator 配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
  health:
    livenessstate:
      enabled: true
    readinessstate:
      enabled: true
  # OpenTelemetry 配置 (Spring Boot 4.0)
  # 取樣率由環境 profile 控制 (lab=1.0, prod=0.1)
  # 本地開發: Docker Compose 自動偵測 grafana-lgtm 容器並配置 OTLP 端點
  # 部署環境: 設定業界標準環境變數 OTEL_EXPORTER_OTLP_ENDPOINT
  tracing:
    sampling:
      probability: 1.0

logging:
  level:
    root: INFO
